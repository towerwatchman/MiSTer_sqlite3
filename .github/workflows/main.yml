name: Build SQLite3 for MiSTer FPGA

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Docker Environment
        run: |
          docker pull raetro/toolchain_mister:latest

      - name: Build SQLite3 and Python Module in Docker
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace raetro/toolchain_mister:latest /bin/bash -c "
            wget https://www.sqlite.org/2023/sqlite-autoconf-3430000.tar.gz &&
            tar -xzf sqlite-autoconf-3430000.tar.gz &&
            mv sqlite-autoconf-3430000 sqlite3-source &&
            cd sqlite3-source &&
            ./configure --host=arm-linux-gnueabihf --prefix=/usr/arm-linux-gnueabihf &&
            make -j$(nproc) &&
            make install DESTDIR=\$PWD/install &&
            cd .. &&
            wget https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tar.xz &&
            tar -xJf Python-3.9.0.tar.xz &&
            cd Python-3.9.0 &&
            ./configure --host=arm-linux-gnueabihf --build=x86_64-linux-gnu \
                        --prefix=/usr/arm-linux-gnueabihf \
                        --enable-shared \
                        --disable-ipv6 \
                        --with-ensurepip=no \
                        ac_cv_file__dev_ptmx=no ac_cv_file__dev_ptc=no &&
            cd Modules/_sqlite &&
            arm-linux-gnueabihf-gcc -c connection.c -o connection.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c cursor.c -o cursor.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c microprotocols.c -o microprotocols.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c module.c -o module.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c prepare_protocol.c -o prepare_protocol.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c row.c -o row.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c statement.c -o statement.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c util.c -o util.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -c cache.c -o cache.o -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -fPIC -I../../Include -I../.. -DMODULE_NAME=\\\"sqlite3\\\" &&
            arm-linux-gnueabihf-gcc -shared -o _sqlite3.so *.o -L../../../sqlite3-source/install/usr/arm-linux-gnueabihf/lib ../../../sqlite3-source/install/usr/arm-linux-gnueabihf/lib/libsqlite3.a -lpthread
          "

      - name: Package Artifacts
        run: |
          mkdir -p artifacts
          cp Python-3.9.0/Modules/_sqlite/_sqlite3.so artifacts/
          tar -czf sqlite3-mister.tar.gz -C artifacts .

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sqlite3-mister
          path: sqlite3-mister.tar.gz

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          VERSION="v$(date +%Y.%m.%d).${{ github.run_number }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$VERSION" -m "Release $VERSION compiled on $(date -u)"
          git push origin "$VERSION"
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --notes "SQLite3 module for MiSTer FPGA compiled on $(date -u)" \
            sqlite3-mister.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
